name: å¼€æºé¡¹ç›®æ›´æ–°ç›‘æ§ä¸åˆ†æ

# è§¦å‘æ¡ä»¶ï¼šæ¯å¤©ä¸­å›½æ—¶é—´å‡Œæ™¨1ç‚¹ï¼ˆUTCæ—¶é—´17:00ï¼‰æ‰§è¡Œï¼Œæ”¯æŒæ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 17 * * *'  # UTCæ—¶é—´17:00 = åŒ—äº¬æ—¶é—´01:00ï¼ˆ+8æ—¶åŒºï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  monitor-projects:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          persist-credentials: true  # ä¿ç•™å‡­æ®ä»¥ä¾¿æäº¤æŠ¥å‘Š
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: å®‰è£…ä¾èµ–åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv requests PyGithub python-dateutil
      
      - name: åˆ›å»ºæŠ¥å‘Šå­˜å‚¨ç›®å½•
        run: mkdir -p reports  # åˆ›å»ºæŠ¥å‘Šå­˜å‚¨ç›®å½•
      
      - name: åŠ è½½é¡¹ç›®é…ç½®
        id: load_config
        run: |
          # ä¸¥æ ¼æ£€æŸ¥é¡¹ç›®é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "projects.json" ]; then
            echo "é”™è¯¯ï¼šé¡¹ç›®é…ç½®æ–‡ä»¶projects.jsonä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºå¹¶é…ç½®è¯¥æ–‡ä»¶"
            exit 1  # æŠ¥é”™é€€å‡º
          fi
          
          # éªŒè¯æ–‡ä»¶æ ¼å¼æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JSON
          if ! jq . projects.json >/dev/null 2>&1; then
            echo "é”™è¯¯ï¼šprojects.jsonä¸æ˜¯æœ‰æ•ˆçš„JSONæ–‡ä»¶"
            exit 1  # æ ¼å¼é”™è¯¯é€€å‡º
          fi
          
          # ç¡®ä¿jqå·²å®‰è£…ï¼ˆç”¨äºJSONæ ¼å¼åŒ–ï¼‰
          if ! command -v jq &> /dev/null; then
            echo "å®‰è£…jqå·¥å…·"
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          
          # è¾“å‡ºé…ç½®æ–‡ä»¶å†…å®¹ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "PROJECTS_CONFIG=$(cat projects.json | jq -c .)" >> $GITHUB_ENV
      
      - name: æ£€æŸ¥æ–°ç‰ˆæœ¬å¹¶åˆ†æ
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}  # æ­¤å¤„ä»ä½¿ç”¨è¯¥å˜é‡åå­˜å‚¨è®¿é—®å¯†é’¥
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECTS_CONFIG: ${{ env.PROJECTS_CONFIG }}
          CUSTOM_MODEL_ENDPOINT: "https://maas-cn-southwest-2.modelarts-maas.com/v1/infers/271c9332-4aa6-4ff5-95b3-0cf8bd94c394/v1"
        run: |
          python - <<END
          import os
          import json
          import openai
          import requests
          from datetime import datetime
          from github import Github
          from dateutil.parser import parse

          # åˆå§‹åŒ–GitHubå®¢æˆ·ç«¯
          g = Github(os.getenv("GITHUB_TOKEN"))
          
          # åŠ è½½é¡¹ç›®é…ç½®
          projects = json.loads(os.getenv("PROJECTS_CONFIG"))
          today = datetime.now().strftime("%Y%m%d")
          china_tz = datetime.now().astimezone().tzinfo  # è·å–ä¸­å›½æ—¶åŒº
          
          # é…ç½®OpenAIå®¢æˆ·ç«¯ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ¨¡å‹è®¿é—®åœ°å€
          client = openai.OpenAI(
              api_key=os.getenv("OPENAI_API_KEY"),
              base_url=os.getenv("CUSTOM_MODEL_ENDPOINT")
          )
          
          if not openai.api_key:
              raise ValueError("OPENAI_API_KEYç¯å¢ƒå˜é‡æœªè®¾ç½®")
          
          if not openai.api_base:
              raise ValueError("è‡ªå®šä¹‰æ¨¡å‹è®¿é—®åœ°å€æœªè®¾ç½®")

          # åˆ†ææç¤ºè¯ - ä¿æŒåŸæœ‰æ ¼å¼
          analysis_prompt_template = """
          ä½œä¸ºä¸€åèµ„æ·±çš„è½¯ä»¶æ¶æ„å¸ˆå’Œå®‰å…¨ä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹å¼€æºé¡¹ç›®çš„æ›´æ–°å†…å®¹ï¼Œ
          å¹¶ä»ä»¥ä¸‹å…­ä¸ªå…³é”®ç»´åº¦è¯„ä¼°æ­¤æ¬¡æ›´æ–°å¯èƒ½å¯¹ä¾èµ–è¯¥å¼€æºè½¯ä»¶çš„åº”ç”¨ç³»ç»Ÿé€ æˆçš„å½±å“ã€‚

          åˆ†æç»´åº¦ï¼š
          1. åŠŸèƒ½å˜æ›´ç»´åº¦
          2. å®‰å…¨é£é™©ç»´åº¦
          3. ç¨³å®šæ€§ä¸æ€§èƒ½ç»´åº¦
          4. å…¼å®¹æ€§ä¸è¿ç§»æˆæœ¬ç»´åº¦
          5. é¡¹ç›®ç»´æŠ¤ä¸ç¤¾åŒºå¥åº·åº¦ç»´åº¦
          6. è®¸å¯è¯ä¸åˆè§„æ€§ç»´åº¦

          è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç”Ÿæˆä¸€ä»½ç¾è§‚ã€æ˜“è¯»çš„åˆ†ææŠ¥å‘Šï¼Œé‡ç‚¹çªå‡ºéœ€è¦å…³æ³¨çš„é£é™©ç‚¹ï¼š

          # {project_name} v{version} æ›´æ–°å½±å“åˆ†ææŠ¥å‘Š
          
          ## ğŸ“… åŸºæœ¬ä¿¡æ¯
          - é¡¹ç›®åç§°: {project_name}
          - ä»“åº“åœ°å€: https://github.com/{repo_full_name}
          - ç‰ˆæœ¬å·: {version}
          - åˆ†ææ—¥æœŸ: {analysis_date}
          
          ## ğŸ” æ€»ä½“è¯„ä¼°
          [è¯·ç»™å‡ºæ€»ä½“å½±å“è¯„çº§ï¼šä½/ä¸­/é«˜ï¼Œå¹¶ç®€è¦è¯´æ˜ç†ç”±]
          
          ## âš ï¸ å…³é”®é£é™©æç¤º
          [åˆ—å‡º3-5ä¸ªæœ€éœ€è¦å…³æ³¨çš„é£é™©ç‚¹ï¼Œä½¿ç”¨åŠ ç²—å’Œè­¦å‘Šç¬¦å·çªå‡ºæ˜¾ç¤º]
          
          ## ğŸ“Š è¯¦ç»†åˆ†æ
          
          ### 1. åŠŸèƒ½å˜æ›´ç»´åº¦
          [è¯¦ç»†åˆ†æå†…å®¹ï¼Œä½¿ç”¨é¡¹ç›®ç¬¦å·åˆ—å‡ºå…³é”®ç‚¹]
          
          ### 2. å®‰å…¨é£é™©ç»´åº¦
          [è¯¦ç»†åˆ†æå†…å®¹ï¼Œä½¿ç”¨é¡¹ç›®ç¬¦å·åˆ—å‡ºå…³é”®ç‚¹ï¼Œå®‰å…¨æ¼æ´ç”¨âš ï¸æ ‡è®°]
          
          ### 3. ç¨³å®šæ€§ä¸æ€§èƒ½ç»´åº¦
          [è¯¦ç»†åˆ†æå†…å®¹ï¼Œä½¿ç”¨é¡¹ç›®ç¬¦å·åˆ—å‡ºå…³é”®ç‚¹]
          
          ### 4. å…¼å®¹æ€§ä¸è¿ç§»æˆæœ¬ç»´åº¦
          [è¯¦ç»†åˆ†æå†…å®¹ï¼Œä½¿ç”¨é¡¹ç›®ç¬¦å·åˆ—å‡ºå…³é”®ç‚¹ï¼Œç ´åæ€§å˜æ›´ç”¨ğŸ”´æ ‡è®°]
          
          ### 5. é¡¹ç›®ç»´æŠ¤ä¸ç¤¾åŒºå¥åº·åº¦ç»´åº¦
          [è¯¦ç»†åˆ†æå†…å®¹ï¼Œä½¿ç”¨é¡¹ç›®ç¬¦å·åˆ—å‡ºå…³é”®ç‚¹]
          
          ### 6. è®¸å¯è¯ä¸åˆè§„æ€§ç»´åº¦
          [è¯¦ç»†åˆ†æå†…å®¹ï¼Œä½¿ç”¨é¡¹ç›®ç¬¦å·åˆ—å‡ºå…³é”®ç‚¹]
          
          ## ğŸ’¡ å»ºè®®æªæ–½
          [åˆ—å‡ºå…·ä½“ã€å¯æ“ä½œçš„å»ºè®®ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº]
          
          ## ğŸ“ è¡¥å……è¯´æ˜
          [ä»»ä½•å…¶ä»–éœ€è¦è¯´æ˜çš„å†…å®¹]
          
          è¯·ç¡®ä¿æŠ¥å‘Šè¯­è¨€ç®€æ´æ˜äº†ï¼Œé‡ç‚¹çªå‡ºï¼Œä½¿ç”¨é€‚å½“çš„Markdownæ ¼å¼ï¼ˆæ ‡é¢˜ã€åˆ—è¡¨ã€å¼ºè°ƒç­‰ï¼‰å¢å¼ºå¯è¯»æ€§ã€‚
          å¯¹äºéœ€è¦ç‰¹åˆ«æ³¨æ„çš„å†…å®¹ï¼Œä½¿ç”¨**åŠ ç²—**ã€âš ï¸ã€ğŸ”´ç­‰ç¬¦å·çªå‡ºæ˜¾ç¤ºã€‚

          é¡¹ç›®æ›´æ–°å†…å®¹ï¼š
          {changelog_content}
          """

          # å¤„ç†æ¯ä¸ªé¡¹ç›®
          for project in projects:
              project_name = project["name"]
              repo_full_name = project["github_repo"]
              last_checked_version = project["last_checked_version"]
              
              print(f"\n===== æ£€æŸ¥é¡¹ç›®: {project_name} ({repo_full_name}) =====")
              
              try:
                  # è·å–ä»“åº“ä¿¡æ¯
                  repo = g.get_repo(repo_full_name)
                  
                  # è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬
                  releases = repo.get_releases()
                  if releases.totalCount == 0:
                      print(f"é¡¹ç›® {project_name} æ²¡æœ‰å‘å¸ƒç‰ˆæœ¬")
                      continue
                  
                  latest_release = releases[0]
                  latest_version = latest_release.tag_name
                  print(f"æœ€æ–°ç‰ˆæœ¬: {latest_version}, ä¸Šæ¬¡æ£€æŸ¥ç‰ˆæœ¬: {last_checked_version}")
                  
                  # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
                  if latest_version == last_checked_version:
                      print("æ²¡æœ‰æ–°ç‰ˆæœ¬ï¼Œè·³è¿‡åˆ†æ")
                      continue
                  
                  # è·å–CHANGELOGå†…å®¹
                  changelog_content = ""
                  try:
                      # å°è¯•è·å–ä»“åº“ä¸­çš„CHANGELOGæ–‡ä»¶
                      changelog_file = repo.get_contents("CHANGELOG.md")
                      changelog_content = changelog_file.decoded_content.decode("utf-8")
                      
                      # å¦‚æœCHANGELOGå¤ªå¤§ï¼Œåªå–æœ€è¿‘çš„éƒ¨åˆ†
                      if len(changelog_content) > 8000:
                          print("CHANGELOGå†…å®¹è¿‡é•¿ï¼Œä»…åˆ†ææœ€è¿‘éƒ¨åˆ†")
                          # å°è¯•æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬çš„ä½ç½®
                          version_header = f"## [{latest_version}]"
                          version_index = changelog_content.rfind(version_header)
                          if version_index != -1:
                              changelog_content = changelog_content[version_index:]
                          else:
                              # å¦‚æœæ‰¾ä¸åˆ°ç‰ˆæœ¬æ ‡é¢˜ï¼Œå–æœ€å8000å­—ç¬¦
                              changelog_content = changelog_content[-8000:]
                  except Exception as e:
                      print(f"è·å–CHANGELOGå¤±è´¥: {str(e)}")
                      # å°è¯•ä½¿ç”¨å‘å¸ƒè¯´æ˜ä½œä¸ºæ›¿ä»£
                      if latest_release.body:
                          changelog_content = f"å‘å¸ƒè¯´æ˜:\n{latest_release.body}"
                      else:
                          print("æ²¡æœ‰æ‰¾åˆ°CHANGELOGæˆ–å‘å¸ƒè¯´æ˜ï¼Œæ— æ³•åˆ†æ")
                          continue
                  
                  # è°ƒç”¨è‡ªå®šä¹‰æ¨¡å‹è¿›è¡Œåˆ†æ
                  print(f"è°ƒç”¨è‡ªå®šä¹‰æ¨¡å‹APIè¿›è¡Œåˆ†æ: {openai.api_base}")
                  analysis_date = datetime.now(china_tz).strftime("%Y-%m-%d %H:%M:%S %Z%z")
                  prompt = analysis_prompt_template.format(
                      project_name=project_name,
                      repo_full_name=repo_full_name,
                      version=latest_version,
                      analysis_date=analysis_date,
                      changelog_content=changelog_content
                  )
                  
                  # è°ƒç”¨è‡ªå®šä¹‰ç«¯ç‚¹çš„ChatCompletionæ¥å£
                  response = client.chat.completions.create(
                      model="DeepSeek-V3",  # æ ¹æ®å®é™…æ¨¡å‹æƒ…å†µè°ƒæ•´
                      messages=[
                          {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è½¯ä»¶å®‰å…¨ä¸æ¶æ„åˆ†æä¸“å®¶ï¼Œæ“…é•¿è¯„ä¼°å¼€æºè½¯ä»¶æ›´æ–°å¯¹ä¾èµ–ç³»ç»Ÿçš„å½±å“ã€‚ä½ çš„æŠ¥å‘Šéœ€è¦ç»“æ„æ¸…æ™°ã€é‡ç‚¹çªå‡ºã€æ˜“äºé˜…è¯»ã€‚"},
                          {"role": "user", "content": prompt}
                      ],
                      temperature=0.3,
                      max_tokens=5000
                  )
                  
                  analysis_result = response.choices[0].message.content
                  
                  # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶å
                  safe_project_name = project_name.replace(" ", "_").replace("/", "_")
                  safe_version = latest_version.replace("v", "").replace(".", "_").replace(" ", "_")
                  report_filename = f"reports/{safe_project_name}_{safe_version}_{today}.md"
                  
                  # ä¿å­˜æŠ¥å‘Š
                  with open(report_filename, "w") as f:
                      f.write(analysis_result)
                  
                  print(f"åˆ†ææŠ¥å‘Šå·²ä¿å­˜è‡³: {report_filename}")
                  
                  # æ›´æ–°é¡¹ç›®é…ç½®ä¸­çš„æœ€åæ£€æŸ¥ç‰ˆæœ¬
                  project["last_checked_version"] = latest_version
                  
              except Exception as e:
                  print(f"å¤„ç†é¡¹ç›® {project_name} æ—¶å‡ºé”™: {str(e)}")
                  continue
          
          # ä¿å­˜æ›´æ–°åçš„é¡¹ç›®é…ç½®
          with open("projects.json", "w") as f:
              json.dump(projects, f, indent=2)
          print("å·²æ›´æ–°é¡¹ç›®é…ç½®æ–‡ä»¶")
          END
        shell: bash
      
      - name: æäº¤å¹¶æ¨é€æŠ¥å‘Š
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æŠ¥å‘Šæˆ–é…ç½®æ›´æ–°
          git config --global user.name "Qi"
          git config --global user.email "todayhill@gmail.com"
          git add reports/ projects.json
          # åªæœ‰åœ¨æœ‰å˜æ›´æ—¶æ‰æäº¤
          if ! git diff --quiet --staged; then
              git commit -m "æ·»åŠ  $(date +'%Y-%m-%d') çš„å¼€æºé¡¹ç›®æ›´æ–°åˆ†ææŠ¥å‘Š"
              git push
          else
              echo "æ²¡æœ‰æ–°æŠ¥å‘Šéœ€è¦æäº¤"
          fi
